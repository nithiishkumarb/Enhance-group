import{F as st,G as A,H as z,I as rt,L,n as ot}from"./chunk-6OEMGNUI.js";import{A as at}from"./chunk-JRGJBYKK.js";import{Xb as et,cc as nt}from"./chunk-K2POHFPS.js";import{D as pt}from"./chunk-7OOXQFUB.js";import{Aa as C,Ab as D,Sb as it,f as mt,pb as X,qb as Z,ub as tt,ya as f,zb as _}from"./chunk-2KNKNWMU.js";import{f as J}from"./chunk-LKJAU4TK.js";import{A as u,Ac as g,Bc as b,Fc as O,Ib as R,Ic as F,Id as q,Jb as w,Kc as x,Pb as d,Qb as I,Rc as K,Sc as Y,Ta as E,Tc as $,Yc as Q,cb as y,db as v,ic as T,ie as B,je as G,nc as c,oc as j,pc as V,v as N,zc as h}from"./chunk-YRZDTKHG.js";import{a as l,b as M,g as U,i as S,j as k}from"./chunk-Z4H5XVQJ.js";k();var H=U(mt());var W=U(pt());var lt=["map"];function ct(s,m){if(s&1&&b(0,"div",10),s&2){let r=x();c("innerHTML",r.label,w)}}function ht(s,m){if(s&1){let r=O();h(0,"button",11),F("click",function(){y(r);let t=x();return v(t.visibleTooltip=!t.visibleTooltip)}),h(1,"mat-icon"),Q(2,"info_outline"),g()()}}function dt(s,m){if(s&1&&b(0,"div",12),s&2){let r=m.$implicit;c("innerHTML",r,w)}}function gt(s,m){if(s&1){let r=O();h(0,"tb-history-selector",13),F("timeUpdated",function(t){y(r);let i=x();return v(i.timeUpdated(t))}),g()}if(s&2){let r=x();c("settings",r.settings)("minTime",r.minTime)("maxTime",r.maxTime)("step",r.normalizationStep)("anchors",r.anchors)("useAnchors",r.useAnchors)}}var ft=(()=>{let m=class m{constructor(e,t){this.cd=e,this.sanitizer=t,this.initialized=!1,this.updatePending=!1,this.mapWidgetUpdatePending=!1,this.interpolatedTimeData=[],this.formattedInterpolatedTimeData=[],this.formattedCurrentPosition=[],this.formattedLatestData=[],this.mainTooltips=[],this.visibleTooltip=!1,this.anchors=[],this.calcTooltip=(i,n)=>{let a=i||this.activeTrip,o=this.settings.useTooltipFunction?D(this.settings.parsedTooltipFunction,[a,n,i.dsIndex]):this.settings.tooltipPattern;return L.parseTemplate(o,a,!0)},this.findFirstHistoricalDataIndexCoordinate=i=>C(i[this.settings.latKeyName])&&C(i[this.settings.lngKeyName])}ngOnInit(){this.widgetConfig=this.ctx.widgetConfig,this.settings=l(l({buttonColor:it(this.widgetConfig.color).setAlpha(.54).toRgbString()},st),this.ctx.settings),this.useAnchors=this.settings.showPoints&&this.settings.usePointAsAnchor,this.normalizationStep=this.settings.normalizationStep;let e=this.ctx.defaultSubscription;e.callbacks.onDataUpdated=()=>{this.update()},e.callbacks.onLatestDataUpdated=()=>{this.latestDataUpdate()},N(this.initializeFunctions()).subscribe(()=>{this.initialized=!0,this.updatePending&&this.updateCurrentData()})}ngAfterViewInit(){import("./chunk-POH6Z3HU.js").then(e=>{this.mapWidget=new e.MapWidgetController(ot.openstreet,!1,this.ctx,this.mapContainer.nativeElement,!1,()=>{this.mapWidgetUpdatePending&&this.updateMapWidget()}),this.mapResize$=new ResizeObserver(()=>{this.mapWidget.resize()}),this.mapResize$.observe(this.mapContainer.nativeElement)})}ngOnDestroy(){this.mapResize$&&this.mapResize$.disconnect()}timeUpdated(e){this.currentTime=e,this.formattedCurrentPosition=this.interpolatedTimeData.map(t=>t[e]);for(let t=0;t<this.interpolatedTimeData.length;t++)if(f(this.formattedCurrentPosition[t])){let i=Object.keys(this.interpolatedTimeData[t]).map(n=>parseInt(n,10));for(let n=1;n<i.length;n++)if(i[n-1]<e&&i[n]>e){let a=this.interpolatedTimeData[t][i[n-1]],o=this.interpolatedTimeData[t][i[n]],p=A(i[n-1],i[n],e);this.formattedCurrentPosition[t]=l(M(l({},a),{time:e}),z(a,o,this.settings.latKeyName,this.settings.lngKeyName,p));break}}for(let t=0;t<this.interpolatedTimeData.length;t++)f(this.formattedCurrentPosition[t])&&(this.formattedCurrentPosition[t]=this.calculateLastPoints(this.interpolatedTimeData[t],e));this.updateCurrentData()}initializeFunctions(){return S(this,null,function*(){this.settings.parsedPointAsAnchorFunction=yield u(_(this.ctx.http,this.settings.pointAsAnchorFunction,["data","dsData","dsIndex"])),this.settings.parsedTooltipFunction=yield u(_(this.ctx.http,this.settings.tooltipFunction,["data","dsData","dsIndex"])),this.settings.parsedLabelFunction=yield u(_(this.ctx.http,this.settings.labelFunction,["data","dsData","dsIndex"])),this.settings.parsedColorPointFunction=yield u(_(this.ctx.http,this.settings.colorPointFunction,["data","dsData","dsIndex"]))})}update(){this.historicalData=Z(this.ctx.data).map(n=>this.clearIncorrectFirsLastDatapoint(n)).filter(n=>n.length),this.interpolatedTimeData.length=0,this.formattedInterpolatedTimeData.length=0;let e=this.minTime,t=this.maxTime;this.calculateIntervals();let i=this.calculateCurrentTime(e,t);i!==this.currentTime&&this.timeUpdated(i),this.updateMapWidget()}latestDataUpdate(){this.formattedLatestData=X(this.ctx.latestData),this.updateCurrentData()}updateMapWidget(){this.mapWidget?.map?(this.mapWidgetUpdatePending=!1,this.mapWidget.map.map?.invalidateSize(),this.mapWidget.map.setLoading(!1),this.cd.detectChanges()):this.mapWidgetUpdatePending=!0}updateCurrentData(){if(this.initialized){this.updatePending=!1;let e=this.formattedCurrentPosition;this.formattedLatestData.length&&(e=tt(this.formattedCurrentPosition,this.formattedLatestData)),this.calcLabel(e),this.calcMainTooltip(e),this.mapWidget?.map?.map&&(this.mapWidget.map.updateFromData(!0,e,this.formattedInterpolatedTimeData,t=>{this.activeTrip=t,this.timeUpdated(this.currentTime),this.cd.markForCheck()}),this.settings.showPoints&&this.mapWidget.map.updatePoints(this.formattedInterpolatedTimeData,this.calcTooltip))}else this.updatePending=!0}setActiveTrip(){}calculateLastPoints(e,t){let i=Object.keys(e),n=i.findIndex(a=>Number(a)>=t);return n!==-1?Number(i[n])!==t&&n!==0&&n--:n=i.length-1,e[i[n]]}calculateIntervals(){let e=1/0,t=-1/0;if(this.historicalData.forEach(i=>{e=Math.min(i[0].time,e),t=Math.max(i[i.length-1].time,t)}),this.minTime=e,this.maxTime=t,this.historicalData.forEach((i,n)=>{this.interpolatedTimeData[n]=this.interpolateArray(i)}),this.formattedInterpolatedTimeData=this.interpolatedTimeData.map(i=>H.default.values(i)),this.activeTrip||(this.activeTrip=this.interpolatedTimeData.map(i=>i[this.minTime]).filter(i=>i)[0]),this.useAnchors){let i=Object.entries(H.default.union(this.interpolatedTimeData)[0]);this.anchors=i.filter((n,a)=>D(this.settings.parsedPointAsAnchorFunction,[n[1],this.formattedInterpolatedTimeData.map(o=>o[a]),n[1].dsIndex])).map(n=>parseInt(n[0],10))}}calcMainTooltip(e){let t=[];for(let i of e)t.push(this.sanitizer.sanitize(R.HTML,this.calcTooltip(i,e)));this.mainTooltips=t}calcLabel(e){if(this.activeTrip){let t=e[this.activeTrip.dsIndex],i=this.settings.useLabelFunction?D(this.settings.parsedLabelFunction,[t,e,t.dsIndex]):this.settings.label;this.label=this.sanitizer.bypassSecurityTrustHtml(L.parseTemplate(i,t,!0))}}interpolateArray(e){let t={},i=this.settings.latKeyName,n=this.settings.lngKeyName;for(let o of e){let p=o.time,P=this.minTime+Math.ceil((p-this.minTime)/this.normalizationStep)*this.normalizationStep;t[P]=M(l({},o),{minTime:this.minTime!==1/0?(0,W.default)(this.minTime).format("YYYY-MM-DD HH:mm:ss"):"",maxTime:this.maxTime!==-1/0?(0,W.default)(this.maxTime).format("YYYY-MM-DD HH:mm:ss"):"",rotationAngle:this.settings.rotationAngle})}let a=Object.keys(t);for(let o=0;o<a.length-1;o++){if(f(t[a[o+1]][i])||f(t[a[o+1]][n])){for(let p=o+2;p<a.length-1;p++)if(C(t[a[p]][i])||C(t[a[p]][n])){let P=A(Number(a[o]),Number(a[p]),Number(a[o+1]));t[a[o+1]]=l(l({},z(t[a[o]],t[a[p]],i,n,P)),t[a[o+1]]);break}}t[a[o]].rotationAngle+=rt(t[a[o]],t[a[o+1]],i,n)}return t}calculateCurrentTime(e,t){return e!==this.minTime||t!==this.maxTime?this.minTime>=this.currentTime||f(this.currentTime)?this.minTime:this.maxTime<=this.currentTime?this.maxTime:this.minTime+Math.ceil((this.currentTime-this.minTime)/this.normalizationStep)*this.normalizationStep:this.currentTime}clearIncorrectFirsLastDatapoint(e){let t=e.findIndex(this.findFirstHistoricalDataIndexCoordinate);if(t===-1)return[];let i=e.length-1;for(i;i>0;i--)if(this.findFirstHistoricalDataIndexCoordinate(e[i])){i++;break}return t>0||i<e.length?e.slice(t,i):e}};m.\u0275fac=function(t){return new(t||m)(I(q),I(J))},m.\u0275cmp=E({type:m,selectors:[["trip-animation"]],viewQuery:function(t,i){if(t&1&&K(lt,5),t&2){let n;Y(n=$())&&(i.mapContainer=n.first)}},inputs:{ctx:"ctx"},decls:10,vars:12,consts:[["map",""],[1,"trip-animation-widget"],["class","trip-animation-label-container",3,"innerHTML",4,"ngIf"],[1,"trip-animation-container","flex","flex-col"],[1,"map"],[1,"trip-animation-info-panel","flex","flex-row"],["class","tooltip-button","mat-mini-fab","","color","primary","aria-label","tooltip",3,"click",4,"ngIf"],[1,"trip-animation-tooltip","md-whiteframe-z4","flex","flex-col"],["style","padding: 10px 0",3,"innerHTML",4,"ngFor","ngForOf"],[3,"settings","minTime","maxTime","step","anchors","useAnchors","timeUpdated",4,"ngIf"],[1,"trip-animation-label-container",3,"innerHTML"],["mat-mini-fab","","color","primary","aria-label","tooltip",1,"tooltip-button",3,"click"],[2,"padding","10px 0",3,"innerHTML"],[3,"timeUpdated","settings","minTime","maxTime","step","anchors","useAnchors"]],template:function(t,i){t&1&&(h(0,"div",1),T(1,ct,1,1,"div",2),h(2,"div",3),b(3,"div",4,0),h(5,"div",5),T(6,ht,3,0,"button",6),g(),h(7,"div",7),T(8,dt,1,1,"div",8),g()(),T(9,gt,1,6,"tb-history-selector",9),g()),t&2&&(d(),c("ngIf",i.settings.showLabel),d(5),c("ngIf",i.settings.showTooltip),d(),j("background-color",i.settings.tooltipColor)("opacity",i.settings.tooltipOpacity)("color",i.settings.tooltipFontColor),V("trip-animation-tooltip-hidden",!i.visibleTooltip),d(),c("ngForOf",i.mainTooltips),d(),c("ngIf",i.historicalData))},dependencies:[B,G,et,nt,at],styles:['@charset "UTF-8";.trip-animation-widget[_ngcontent-%COMP%]{position:relative;width:100%;height:100%;font-size:16px;line-height:24px;display:flex;flex-direction:column}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-label-container[_ngcontent-%COMP%]{height:24px}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]{position:relative;z-index:1;flex:1;width:100%}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .map[_ngcontent-%COMP%]{width:100%;height:100%}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]{position:absolute;top:0;right:0;pointer-events:none}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]   .tooltip-button[_ngcontent-%COMP%]{top:0;left:0;width:32px;min-width:32px;height:32px;min-height:32px;margin:2px;line-height:24px;z-index:999}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]   .tooltip-button[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]{width:24px;height:24px}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]   .tooltip-button[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:inherit;height:inherit}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-tooltip[_ngcontent-%COMP%]{display:flex;overflow:auto;max-height:90%;position:absolute;top:30px;right:0;z-index:1000;padding:5px;background-color:#fff;transition:.3s ease-in-out}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-tooltip-hidden[_ngcontent-%COMP%]{transform:translate(110%)}']});let s=m;return s})(),Wt=ft;export{ft as a,Wt as b};
