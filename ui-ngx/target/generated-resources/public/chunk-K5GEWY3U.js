import{k as E}from"./chunk-JIUP6ZA4.js";import{D as Y,Od as H,aa as L,ee as C,nb as D,ob as w}from"./chunk-7OOXQFUB.js";import{Aa as m,Ba as v,Ga as b,Ha as P,Sb as F,_a as x,ab as A,lb as W,mb as I,pb as T,ya as S}from"./chunk-2KNKNWMU.js";import{i as k}from"./chunk-YRZDTKHG.js";import{g as R,j as M}from"./chunk-Z4H5XVQJ.js";M();var U=R(Y());var K=U.default,z=class{constructor(t,i,e,s){this.ctx=t,this.chartType=i,this.$flotElement=e,this.plotInited=!1,this.isMouseInteraction=!1,this.flotHoverHandler=this.onFlotHover.bind(this),this.flotSelectHandler=this.onFlotSelect.bind(this),this.dblclickHandler=this.onFlotDblClick.bind(this),this.mousedownHandler=this.onFlotMouseDown.bind(this),this.mouseupHandler=this.onFlotMouseUp.bind(this),this.mouseleaveHandler=this.onFlotMouseLeave.bind(this),this.flotClickHandler=this.onFlotClick.bind(this),this.yMinSubject=new k(-1),this.yMaxSubject=new k(1),this.yMin$=this.yMinSubject.asObservable(),this.yMax$=this.yMaxSubject.asObservable(),this.chartType=this.chartType||"line",this.settings=s||t.settings,this.utils=this.ctx.$injector.get(E),this.enableSelection=m(this.settings.enableSelection)?this.settings.enableSelection:!0,this.selectionMode=this.enableSelection?"x":null,this.showTooltip=m(this.settings.showTooltip)?this.settings.showTooltip:!0,this.tooltip=this.showTooltip?$("#flot-series-tooltip"):null,this.tooltip?.length===0&&(this.tooltip=this.createTooltipElement()),this.trackDecimals=t.decimals,this.trackUnits=t.units,this.tooltipIndividual=this.chartType==="pie"||(m(this.settings.tooltipIndividual)?this.settings.tooltipIndividual:!1),this.tooltipCumulative=m(this.settings.tooltipCumulative)?this.settings.tooltipCumulative:!1,this.hideZeros=m(this.settings.hideZeros)?this.settings.hideZeros:!1;let a={color:this.settings.fontColor||"#545454",size:this.settings.fontSize||10,family:"Roboto"};if(this.options={title:null,subtitile:null,shadowSize:m(this.settings.shadowSize)?this.settings.shadowSize:4,HtmlText:!1,grid:{hoverable:!0,mouseActiveRadius:10,autoHighlight:this.tooltipIndividual===!0,markings:[]},legend:{show:!1}},this.chartType==="line"||this.chartType==="bar"||this.chartType==="state"){if(this.options.selection={mode:this.selectionMode,touch:!0},this.options.xaxes=[],this.xaxis={mode:"time",timezone:"browser",font:x(a),labelFont:x(a)},this.yaxis={font:x(a),labelFont:x(a)},this.settings.xaxis&&(this.xaxis.font.color=this.settings.xaxis.color||this.xaxis.font.color,this.xaxis.label=this.utils.customTranslation(this.settings.xaxis.title,this.settings.xaxis.title)||null,this.xaxis.labelFont.color=this.xaxis.font.color,this.xaxis.labelFont.size=this.xaxis.font.size+2,this.xaxis.labelFont.weight="bold"),this.yAxisTickFormatter=this.formatYAxisTicks.bind(this),this.yaxis.tickFormatter=this.yAxisTickFormatter,this.settings.yaxis){if(this.yaxis.font.color=this.settings.yaxis.color||this.yaxis.font.color,this.yaxis.min=b(this.settings.yaxis.min)?this.settings.yaxis.min:null,this.yaxis.max=b(this.settings.yaxis.max)?this.settings.yaxis.max:null,this.yaxis.label=this.utils.customTranslation(this.settings.yaxis.title,this.settings.yaxis.title)||null,this.yaxis.labelFont.color=this.yaxis.font.color,this.yaxis.labelFont.size=this.yaxis.font.size+2,this.yaxis.labelFont.weight="bold",b(this.settings.yaxis.tickSize)?this.yaxis.tickSize=this.settings.yaxis.tickSize:this.yaxis.tickSize=null,this.settings.yaxis.tickGenerator?.length)try{this.yaxis.ticks=new Function("axis",this.settings.yaxis.tickGenerator)}catch{}if(b(this.settings.yaxis.tickDecimals)?this.yaxis.tickDecimals=this.settings.yaxis.tickDecimals:this.yaxis.tickDecimals=null,this.settings.yaxis.ticksFormatter&&this.settings.yaxis.ticksFormatter.length)try{this.yaxis.ticksFormatterFunction=new Function("value",this.settings.yaxis.ticksFormatter)}catch{this.yaxis.ticksFormatterFunction=null}}this.options.grid.borderWidth=1,this.options.grid.color=this.settings.fontColor||"#545454",this.settings.grid&&(this.options.grid.color=this.settings.grid.color||"#545454",this.options.grid.backgroundColor=this.settings.grid.backgroundColor||null,this.options.grid.tickColor=this.settings.grid.tickColor||"#DDDDDD",this.options.grid.borderWidth=m(this.settings.grid.outlineWidth)?this.settings.grid.outlineWidth:1,this.settings.grid.verticalLines===!1&&(this.xaxis.tickLength=0),this.settings.grid.horizontalLines===!1&&(this.yaxis.tickLength=0),m(this.settings.grid.margin)&&(this.options.grid.margin=this.settings.grid.margin),m(this.settings.grid.minBorderMargin)&&(this.options.grid.minBorderMargin=this.settings.grid.minBorderMargin)),this.options.xaxes[0]=x(this.xaxis),this.settings.xaxis&&this.settings.xaxis.showLabels===!1&&(this.options.xaxes[0].tickFormatter=()=>""),this.options.series={},this.options.crosshair={mode:"x"},this.chartType==="line"&&this.settings.smoothLines&&(this.options.series.curvedLines={active:!0,monotonicFit:!0}),(this.chartType==="line"||this.chartType==="bar")&&isFinite(this.settings.thresholdsLineWidth)&&(this.options.grid.markingsLineWidth=this.settings.thresholdsLineWidth),this.chartType==="bar"&&(this.options.series.lines={show:!1,fill:!1,steps:!1},this.options.series.bars={show:!0,lineWidth:0,fill:.9,align:this.settings.barAlignment||"left"},this.defaultBarWidth=this.settings.defaultBarWidth||600),this.chartType==="state"&&(this.options.series.lines={steps:!0,show:!0})}else this.chartType==="pie"&&(this.options.series={pie:{show:!0,label:{show:this.settings.showLabels===!0},radius:this.settings.radius||1,innerRadius:this.settings.innerRadius||0,stroke:{color:"#fff",width:0},tilt:this.settings.tilt||1,shadow:{left:5,top:15,alpha:.02}}},this.options.grid.clickable=!0,this.settings.stroke&&(this.options.series.pie.stroke.color=this.settings.stroke.color||"#fff",this.options.series.pie.stroke.width=this.settings.stroke.width||0,this.options.series.pie.stroke.width&&this.scalingPieRadius()),this.options.series.pie.label.show&&(this.options.series.pie.label.formatter=(l,h)=>`<div class='pie-label'>${h.dataKey.label}<br/>${Math.round(h.percent)}%</div>`,this.options.series.pie.label.radius=3/4,this.options.series.pie.label.background={opacity:.8}),this.animatedPie=this.settings.animatedPie===!0);this.ctx.defaultSubscription&&this.init(this.$flotElement||this.ctx.$container,this.ctx.defaultSubscription)}init(t,i){if(this.$element=t,this.$element.css("letter-spacing","normal"),this.subscription=i,this.comparisonEnabled=this.subscription?this.subscription.comparisonEnabled:this.settings.comparisonEnabled,this.comparisonEnabled){let o=x(this.xaxis);o.position="top",this.settings.xaxisSecond&&(this.settings.xaxisSecond.showLabels===!1&&(o.tickFormatter=()=>""),o.label=this.utils.customTranslation(this.settings.xaxisSecond.title,this.settings.xaxisSecond.title)||null,o.position=this.settings.xaxisSecond.axisPosition),o.tickLength=0,this.options.xaxes.push(o),this.options.series.stack=!1}else this.options.series.stack=this.settings.stack===!0;let e=[];this.yaxes=[];let s={},a=[],l=[];if(this.settings.customLegendEnabled&&this.settings.dataKeysListForLabels?.length){this.labelPatternsSourcesData=[];let o=[];this.settings.dataKeysListForLabels.forEach(n=>{n.settings={}}),this.subscription.datasources.forEach(n=>{let r={type:n.type,entityType:n.entityType,entityId:n.entityId,dataKeys:this.settings.dataKeysListForLabels};o.push(r)}),this.subscribeForLabelPatternsSources(o)}let h=null;if(this.settings.tooltipValueFormatter&&this.settings.tooltipValueFormatter.length)try{h=new Function("value","latestData",this.settings.tooltipValueFormatter)}catch{h=null}for(let o=0;o<this.subscription.data.length;o++){let n=this.subscription.data[o],r=n.dataKey.settings;if(n.dataKey.tooltipValueFormatFunction=h,r.tooltipValueFormatter&&r.tooltipValueFormatter.length)try{n.dataKey.tooltipValueFormatFunction=new Function("value","latestData",r.tooltipValueFormatter)}catch{n.dataKey.tooltipValueFormatFunction=h}if(n.lines={fill:r.fillLines===!0?r.fillLinesOpacity||.4:!1},this.settings.stack&&!this.comparisonEnabled?n.stack=!r.excludeFromStacking:n.stack=!1,this.chartType==="line"||this.chartType==="state"?n.lines.show=r.showLines!==!1:n.lines.show=r.showLines===!0,m(r.lineWidth)&&r.lineWidth!==null&&(n.lines.lineWidth=r.lineWidth),n.points={show:!1,radius:8},r.showPoints===!0&&(n.points.show=!0,n.points.lineWidth=m(r.showPointsLineWidth)?r.showPointsLineWidth:5,n.points.radius=m(r.showPointsRadius)?r.showPointsRadius:3,n.points.symbol=m(r.showPointShape)?r.showPointShape:"circle",n.points.symbol==="custom"&&r.pointShapeFormatter))try{n.points.symbol=new Function("ctx, x, y, radius, shadow",r.pointShapeFormatter)}catch{n.points.symbol="circle"}this.chartType==="line"&&this.settings.smoothLines&&!n.points.show&&(n.curvedLines={apply:!0});let f=F(n.dataKey.color);if(e.push(f.toRgbString()),f.setAlpha(.75),n.highlightColor=f.toRgbString(),n.datasource.isAdditional?(n.xaxisIndex=1,n.xaxis=2):(n.xaxisIndex=0,n.xaxis=1),this.yaxis){let c=n.dataKey.units&&n.dataKey.units.length?n.dataKey.units:this.trackUnits,p;if(r.showSeparateAxis?(p=this.createYAxis(r,c),this.yaxes.push(p)):(p=s[c],p||(p=this.createYAxis(r,c),s[c]=p,this.yaxes.push(p))),n.yaxisIndex=this.yaxes.indexOf(p),n.yaxis=n.yaxisIndex+1,p.keysInfo[o]={hidden:!1},p.show=!0,r.thresholds&&r.thresholds.length){for(let d of r.thresholds)if(d.thresholdValueSource==="predefinedValue"&&isFinite(d.thresholdValue)){let g=this.subscription.data.length+a.length,u=this.generateThreshold(a,n.yaxis,d.lineWidth,d.color,g,d.thresholdValue);u!=null&&a.push(u)}else if(d.thresholdEntityAlias&&d.thresholdAttribute){let g=this.ctx.aliasController.getEntityAliasId(d.thresholdEntityAlias);if(!g)continue;let u=l.filter(V=>V.entityAliasId===g)[0],y={type:L.attribute,name:d.thresholdAttribute,label:d.thresholdAttribute,settings:{yaxis:n.yaxis,lineWidth:d.lineWidth,color:d.color},_hash:Math.random()};u?u.dataKeys.push(y):(u={type:C.entity,name:d.thresholdEntityAlias,aliasName:d.thresholdEntityAlias,entityAliasId:g,dataKeys:[y]},l.push(u))}}}this.labelPatternsSourcesData?.length&&this.substituteLabelPatterns(n,o)}if(this.subscribeForThresholdsAttributes(l),this.predefinedThresholds=a,this.options.colors=e,this.options.yaxes=x(this.yaxes),this.chartType==="line"||this.chartType==="bar"||this.chartType==="state"){this.chartType==="bar"&&(this.subscription.timeWindowConfig.aggregation&&this.subscription.timeWindowConfig.aggregation.type===w.NONE?this.options.series.bars.barWidth=this.defaultBarWidth:this.options.series.bars.barWidth=D.numberValue(this.subscription.timeWindow.interval)*.6),this.options.xaxes[0].min=this.subscription.timeWindow.minTime,this.options.xaxes[0].max=this.subscription.timeWindow.maxTime,this.comparisonEnabled&&(this.options.xaxes[1].min=this.subscription.comparisonTimeWindow.minTime,this.options.xaxes[1].max=this.subscription.comparisonTimeWindow.maxTime);let o=x(this.predefinedThresholds);this.attributesThresholds&&(o=o.concat(this.attributesThresholds)),this.latestDataThresholds=this.thresholdsSourcesDataUpdated(o,this.subscription.latestData,!0),this.options.grid.markings=o.concat(this.latestDataThresholds),this.subscription.latestData?this.latestData=T(this.subscription.latestData):this.latestData=[]}else this.chartType==="pie"&&(this.latestData=T(this.subscription.data));if(this.checkMouseEvents(),this.plot&&this.plot.destroy(),this.chartType==="pie"&&this.animatedPie){this.pieDataAnimationDuration=250,this.pieData=x(this.subscription.data),this.pieRenderedData=[],this.pieTargetData=[];for(let o=0;o<this.subscription.data.length;o++)this.pieTargetData[o]=this.subscription.data[o].data&&this.subscription.data[o].data[0]?this.subscription.data[o].data[0][1]:0;this.pieDataRendered()}this.plotInited=!0,this.createPlot()}update(){if(this.updateTimeoutHandle&&(clearTimeout(this.updateTimeoutHandle),this.updateTimeoutHandle=null),this.subscription)if(!this.isMouseInteraction&&this.plot)if(this.chartType==="line"||this.chartType==="bar"||this.chartType==="state"){let t=!1;if(this.yaxis){for(let i=0;i<this.subscription.data.length;i++){let e=this.subscription.data[i],s=e.yaxisIndex;this.yaxes[s].keysInfo[i].hidden!==e.dataKey.hidden&&(this.yaxes[s].keysInfo[i].hidden=e.dataKey.hidden,t=!0),this.labelPatternsSourcesData?.length&&this.substituteLabelPatterns(e,i)}t&&(this.options.yaxes.length=0,this.yaxes.forEach(i=>{let e=!0;i.keysInfo.forEach(a=>{a&&(e=e&&a.hidden)}),i.hidden=e;let s=1;i.hidden||(this.options.yaxes.push(i),s=this.options.yaxes.length);for(let a=0;a<i.keysInfo.length;a++)i.keysInfo[a]&&(this.subscription.data[a].yaxis=s)}),this.options.yaxis={show:!!this.options.yaxes.length})}this.options.xaxes[0].min=this.subscription.timeWindow.minTime,this.options.xaxes[0].max=this.subscription.timeWindow.maxTime,this.comparisonEnabled&&(this.options.xaxes[1].min=this.subscription.comparisonTimeWindow.minTime,this.options.xaxes[1].max=this.subscription.comparisonTimeWindow.maxTime),this.chartType==="bar"&&(this.subscription.timeWindowConfig.aggregation&&this.subscription.timeWindowConfig.aggregation.type===w.NONE?this.options.series.bars.barWidth=this.defaultBarWidth:this.options.series.bars.barWidth=D.numberValue(this.subscription.timeWindow.interval)*.6),t?this.redrawPlot():(this.plot.getOptions().xaxes[0].min=this.subscription.timeWindow.minTime,this.plot.getOptions().xaxes[0].max=this.subscription.timeWindow.maxTime,this.comparisonEnabled&&(this.plot.getOptions().xaxes[1].min=this.subscription.comparisonTimeWindow.minTime,this.plot.getOptions().xaxes[1].max=this.subscription.comparisonTimeWindow.maxTime),this.chartType==="bar"&&(this.subscription.timeWindowConfig.aggregation&&this.subscription.timeWindowConfig.aggregation.type===w.NONE?this.plot.getOptions().series.bars.barWidth=this.defaultBarWidth:this.plot.getOptions().series.bars.barWidth=D.numberValue(this.subscription.timeWindow.interval)*.6),this.updateData())}else this.chartType==="pie"&&(this.latestData=T(this.subscription.data),this.animatedPie?this.nextPieDataAnimation(!0):this.updateData());else this.isMouseInteraction&&this.plot&&(this.updateTimeoutHandle=setTimeout(this.update.bind(this),30))}latestDataUpdate(){if(this.latestUpdateTimeoutHandle&&(clearTimeout(this.latestUpdateTimeoutHandle),this.latestUpdateTimeoutHandle=null),this.subscription)if(!this.isMouseInteraction&&this.plot){if(this.chartType==="line"||this.chartType==="bar"||this.chartType==="state"){let t=x(this.predefinedThresholds);this.attributesThresholds&&(t=t.concat(this.attributesThresholds)),this.latestDataThresholds=this.thresholdsSourcesDataUpdated(t,this.subscription.latestData,!0),this.options.grid.markings=t.concat(this.latestDataThresholds),this.plot&&(this.plot.getOptions().grid.markings=this.options.grid.markings,this.updateData()),this.subscription.latestData?this.latestData=T(this.subscription.latestData):this.latestData=[]}}else this.isMouseInteraction&&this.plot&&(this.latestUpdateTimeoutHandle=setTimeout(this.latestDataUpdate.bind(this),30))}updateSeriesColor(t){if(this.subscription?.data?.length){let i=this.subscription.data[0];i.dataKey.color=t,i.color=t,i.highlightColor=F(t).setAlpha(.75).toRgbString()}}latestDataByDataIndex(t){return this.latestData[t]?this.latestData[t]:{}}scalingPieRadius(){let t;this.ctx.width>this.ctx.height?t=this.ctx.height:t=this.ctx.width;let i=this.options.series.pie.stroke.width/t;this.options.series.pie.radius=i<1?this.settings.radius-i:0}resize(){if(this.resizeTimeoutHandle&&(clearTimeout(this.resizeTimeoutHandle),this.resizeTimeoutHandle=null),this.plot&&this.plotInited)if(this.chartType==="pie"&&this.settings.stroke?.width)this.scalingPieRadius(),this.redrawPlot();else{let t=this.$element.width(),i=this.$element.height();t&&i?(this.plot.resize(),this.chartType!=="pie"&&this.plot.setupGrid(),this.plot.draw()):this.resizeTimeoutHandle=setTimeout(this.resize.bind(this),30)}}checkMouseEvents(){let t=!this.ctx.isEdit;(S(this.mouseEventsEnabled)||this.mouseEventsEnabled!==t)&&(this.mouseEventsEnabled=t,this.$element&&(t?this.enableMouseEvents():this.disableMouseEvents(),this.redrawPlot()))}destroy(){this.cleanup(),this.tooltip&&(this.tooltip.stop(!0),this.tooltip.hide()),this.plot&&(this.plot.destroy(),this.plot=null,this.plotInited=!1)}cleanup(){this.updateTimeoutHandle&&(clearTimeout(this.updateTimeoutHandle),this.updateTimeoutHandle=null),this.latestUpdateTimeoutHandle&&(clearTimeout(this.latestUpdateTimeoutHandle),this.latestUpdateTimeoutHandle=null),this.createPlotTimeoutHandle&&(clearTimeout(this.createPlotTimeoutHandle),this.createPlotTimeoutHandle=null),this.resizeTimeoutHandle&&(clearTimeout(this.resizeTimeoutHandle),this.resizeTimeoutHandle=null),this.yMinSubject.complete(),this.yMaxSubject.complete()}createPlot(){if(this.createPlotTimeoutHandle&&(clearTimeout(this.createPlotTimeoutHandle),this.createPlotTimeoutHandle=null),this.plotInited&&!this.plot){let t=this.$element.width(),i=this.$element.height();t&&i?(this.chartType==="pie"&&this.animatedPie?this.plot=$.plot(this.$element,this.pieData,this.options):this.plot=$.plot(this.$element,this.subscription.data,this.options),this.updateYMinMax()):this.createPlotTimeoutHandle=setTimeout(this.createPlot.bind(this),30)}}updateData(){this.plot.setData(this.subscription.data),this.chartType!=="pie"&&this.plot.setupGrid(),this.plot.draw(),this.updateYMinMax()}updateYMinMax(){if(this.plot?.getYAxes().length){let t=this.plot?.getYAxes()[0].min,i=this.plot?.getYAxes()[0].max;this.yMinSubject.value!==t&&this.yMinSubject.next(t),this.yMaxSubject.value!==i&&this.yMaxSubject.next(i)}}redrawPlot(){this.plot&&this.plotInited&&(this.plot.destroy(),this.plot=null,this.createPlot())}createYAxis(t,i){let e=x(this.yaxis),s,a,l=t.axisTitle&&t.axisTitle.length?t.axisTitle:e.label;b(t.axisTickDecimals)?s=t.axisTickDecimals:s=e.tickDecimals,b(t.axisTickSize)?a=t.axisTickSize:a=e.tickSize;let h=t.axisPosition&&t.axisPosition.length?t.axisPosition:"left",o=b(t.axisMin)?t.axisMin:e.min,n=b(t.axisMax)?t.axisMax:e.max;if(e.label=l,e.min=o,e.max=n,e.tickUnits=i,e.tickDecimals=s,e.tickSize=a,h==="right"&&a===null?e.alignTicksWithAxis=1:e.alignTicksWithAxis=null,e.position=h,e.keysInfo=[],t.axisTicksFormatter&&t.axisTicksFormatter.length)try{e.ticksFormatterFunction=new Function("value",t.axisTicksFormatter)}catch{e.ticksFormatterFunction=this.yaxis.ticksFormatterFunction}return e}subscribeForThresholdsAttributes(t){let i={datasources:t,useDashboardTimewindow:!1,type:H.latest,callbacks:{onDataUpdated:e=>{let s=x(this.predefinedThresholds);this.latestDataThresholds&&(s=s.concat(this.latestDataThresholds)),this.attributesThresholds=this.thresholdsSourcesDataUpdated(s,e.data),this.options.grid.markings=s.concat(this.attributesThresholds),this.plot&&(this.plot.getOptions().grid.markings=this.options.grid.markings,this.updateData())}}};this.ctx.subscriptionApi.createSubscription(i,!0).subscribe(e=>{this.thresholdsSourcesSubscription=e})}thresholdsSourcesDataUpdated(t,i,e=!1){let s=[];return i.forEach(a=>{!(e&&!a.dataKey.settings.useAsThreshold)&&a&&a.data&&a.data[0]&&this.parseThresholdData(a.data[0][1]).forEach(o=>{let n=this.processSingleDataValue(o,a,a.dataKey.settings,t,e);n!=null&&s.push(n)})}),s}parseThresholdData(t){let i;try{let e=JSON.parse(t);i=Array.isArray(e)?e:[e]}catch{i=[t]}return i}processSingleDataValue(t,i,e,s,a=!1){if(P(t)&&isFinite(t)){let l,h,o;if(a)l=1,h=e.thresholdLineWidth,o=e.thresholdColor||i.dataKey.color;else{let r=i.dataKey.settings;l=r.yaxis,h=r.lineWidth,o=r.color||i.dataKey.color}let n=this.subscription.data.length+s.length;return this.generateThreshold(s,l,h,o,n,t)}}generateThreshold(t,i,e,s,a,l){let h={},o;return m(i)&&i!==1?o="y"+i+"axis":o="yaxis",isFinite(e)&&(h.lineWidth=e),m(s)?h.color=s:h.color=this.utils.getMaterialColor(a),h[o]={from:l,to:l},t.filter(r=>A(r[o],h[o])).length?null:h}subscribeForLabelPatternsSources(t){let i={datasources:t,useDashboardTimewindow:!1,type:H.latest,callbacks:{onDataUpdated:e=>{this.labelPatternsParamsDataUpdated(e.data)}}};this.ctx.subscriptionApi.createSubscription(i,!0).subscribe(e=>{this.labelPatternsSourcesSubscription=e})}labelPatternsParamsDataUpdated(t){this.labelPatternsSourcesData=t;for(let i=0;i<this.subscription.data.length;i++){let e=this.subscription.data[i];this.substituteLabelPatterns(e,i)}this.plot&&this.updateData(),this.ctx.detectChanges()}substituteLabelPatterns(t,i){let e=this.labelPatternsSourcesData.filter(a=>a.datasource.entityId===t.datasource.entityId),s=I(t.datasource,t.dataKey.pattern);if(e.forEach(a=>{if(a&&a.data&&a.data[0]){let l=a.data[0][1],h=a.dataKey.name;m(l)&&l!==null&&(s=W(s,h,l))}}),m(this.subscription.legendData)){let a=this.subscription.legendData.keys.findIndex(l=>l.dataIndex===i);a!==-1&&(this.subscription.legendData.keys[a].dataKey.label=s)}t.dataKey.label=s}seriesInfoDiv(t,i,e,s,a,l,h,o,n){let r=$("<div></div>");r.css({display:"flex",alignItems:"center",justifyContent:"space-between"});let f=$("<span></span>");f.css({backgroundColor:i,width:"20px",height:"3px",display:"inline-block",verticalAlign:"middle",marginRight:"5px"}),r.append(f);let c=$(`<span>${t}:</span>`);c.css({marginRight:"10px"}),l&&c.css({color:"#FFF",fontWeight:"700"}),r.append(c);let p;n?p=n(e,this.latestDataByDataIndex(o)):p=this.ctx.utils.formatValue(e,a,s),b(h)&&(p+=" ("+Math.round(h)+" %)");let d=$(`<span>${p}</span>`);return d.css({marginLeft:"auto",fontWeight:"700"}),l&&d.css({color:"#FFF"}),r.append(d),r}seriesInfoDivFromInfo(t,i){let e=t.units&&t.units.length?t.units:this.trackUnits,s=v(t.decimals)?t.decimals:this.trackDecimals;return this.seriesInfoDiv(t.label,t.color,t.value,e,s,t.index===i,null,t.index,t.tooltipValueFormatFunction).prop("outerHTML")}createTooltipElement(){let t=$('<div id="flot-series-tooltip" class="flot-mouse-value"></div>');return t.css({fontSize:"12px",fontFamily:"Roboto",fontWeight:"300",lineHeight:"18px",opacity:"1",backgroundColor:"rgba(0,0,0,0.7)",color:"#D9DADB",position:"absolute",display:"none",zIndex:"1100",padding:"4px 10px",borderRadius:"4px"}).appendTo("body"),t}formatPieTooltip(t){let i=t.series.dataKey.units&&t.series.dataKey.units.length?t.series.dataKey.units:this.trackUnits,e=v(t.series.dataKey.decimals)?t.series.dataKey.decimals:this.trackDecimals;return this.seriesInfoDiv(t.series.dataKey.label,t.series.dataKey.color,t.datapoint[1][0][1],i,e,!0,t.series.percent,0,t.series.dataKey.tooltipValueFormatFunction).prop("outerHTML")}formatChartTooltip(t,i){let e="";if(this.tooltipIndividual){let s;t[1]&&t[1].seriesHover.length?s=t[0].seriesHover.concat(t[1].seriesHover):s=t[0].seriesHover;let a=s.filter(l=>l.index===i);if(a&&a.length){let l=parseInt(a[0].time,10),h=K(l).format("YYYY-MM-DD HH:mm:ss"),o=$("<div>"+h+"</div>");o.css({display:"flex",alignItems:"center",justifyContent:"center",padding:"4px",fontWeight:"700"}),e+=o.prop("outerHTML"),e+=this.seriesInfoDivFromInfo(a[0],i)}}else{let s;t[1]&&t[1].seriesHover.length?s=5:s=15;let a=0;t[1]&&t[1].seriesHover.length>t[0].seriesHover.length?a=Math.ceil(t[1].seriesHover.length/s):a=Math.ceil(t[0].seriesHover.length/s),t.forEach(l=>{if(b(l.time)){let h="",o=parseInt(l.time,10),n=K(o).format("YYYY-MM-DD HH:mm:ss"),r=$("<div>"+n+"</div>");r.css({display:"flex",alignItems:"center",justifyContent:"center",padding:"4px",fontWeight:"700"}),e+=r.prop("outerHTML");let f=$("<div></div>");f.css({display:"flex",flexDirection:"row"});for(let c=0;c<a;c++){let p=$("<div></div>");p.css({display:"flex",flexDirection:"column",flex:"1"});let d="";for(let g=c*s;g<(c+1)*s&&!(g>=l.seriesHover.length);g++){let u=l.seriesHover[g];d+=this.seriesInfoDivFromInfo(u,i)}p.html(d),d&&(c>0&&(h+='<span style="min-width: 20px;"></span>'),h+=p.prop("outerHTML"))}f.html(h),e+=f.prop("outerHTML")}})}return e}formatYAxisTicks(t,i){if(this.settings.yaxis&&this.settings.yaxis.showLabels===!1)return"";if(i.options.ticksFormatterFunction)return i.options.ticksFormatterFunction(t);let e=i.options.tickDecimals?Math.pow(10,i.options.tickDecimals):1,s=""+Math.round(t*e)/e;if(m(i.options.tickDecimals)&&i.options.tickDecimals!==null){let a=s.indexOf("."),l=a===-1?0:s.length-a-1;l<i.options.tickDecimals&&(s=(l?s:s+".")+(""+e).substr(1,i.options.tickDecimals-l))}return i.options.tickUnits&&(s+=" "+i.options.tickUnits),s}enableMouseEvents(){this.$element.css("pointer-events",""),this.$element.addClass("mouse-events"),this.chartType!=="pie"&&(this.options.selection={mode:this.selectionMode,touch:!0},this.$element.bind("plotselected",this.flotSelectHandler),this.$element.bind("dblclick",this.dblclickHandler)),this.$element.bind("plothover",this.flotHoverHandler),this.$element.bind("mousedown",this.mousedownHandler),this.$element.bind("mouseup",this.mouseupHandler),this.$element.bind("mouseleave",this.mouseleaveHandler),this.$element.bind("plotclick",this.flotClickHandler)}disableMouseEvents(){this.$element.css("pointer-events","none"),this.$element.removeClass("mouse-events"),this.chartType!=="pie"&&(this.options.selection={mode:null},this.$element.unbind("plotselected",this.flotSelectHandler),this.$element.unbind("dblclick",this.dblclickHandler)),this.$element.unbind("plothover",this.flotHoverHandler),this.$element.unbind("mousedown",this.mousedownHandler),this.$element.unbind("mouseup",this.mouseupHandler),this.$element.unbind("mouseleave",this.mouseleaveHandler),this.$element.unbind("plotclick",this.flotClickHandler)}onFlotHover(t,i,e){if(!(!this.plot||!this.tooltip))if((!this.tooltipIndividual||e)&&!this.ctx.isEdit){let s=!this.tooltipIndividual;s&&this.plot.unhighlight();let a=i.pageX,l=i.pageY,h,o;if(this.chartType==="pie"?h=this.formatPieTooltip(e):(o=this.getHoverInfo(this.plot.getData(),i),(b(o[0].time)||o[1]&&b(o[1].time))&&(o[0].seriesHover.sort((n,r)=>r.value-n.value),o[1]&&o[1].seriesHover.length&&o[1].seriesHover.sort((n,r)=>r.value-n.value),h=this.formatChartTooltip(o,e?e.seriesIndex:-1))),h){this.tooltip.html(h).css({top:0,left:0}).fadeIn(200);let n=$(window).width(),r=$(window).height(),f=this.tooltip.width(),c=this.tooltip.height(),p=a+5,d=l+5;n-a<f+50&&(p=a-f-10),r-l<c+20&&(d=l-c-10),this.tooltip.css({top:d,left:p}),s&&o.forEach(g=>{g.seriesHover.forEach(u=>{this.plot.highlight(u.index,u.hoverIndex)})})}}else this.tooltip.stop(!0),this.tooltip.hide(),this.plot.unhighlight()}onFlotSelect(t,i){this.plot&&(this.plot.clearSelection(),this.subscription.onUpdateTimewindow(i.xaxis.from,i.xaxis.to))}onFlotDblClick(){this.subscription.onResetTimewindow()}onFlotMouseDown(){this.isMouseInteraction=!0}onFlotMouseUp(){this.isMouseInteraction=!1}onFlotMouseLeave(){this.tooltip&&(this.tooltip.stop(!0),this.tooltip.hide(),this.plot&&this.plot.unhighlight(),this.isMouseInteraction=!1)}onFlotClick(t,i,e){this.plot&&this.onPieSliceClick(t,e)}getHoverInfo(t,i){let e,s,a,l,h,o,n,r,f,c,p=0,d,g=0,u=[{seriesHover:[]}];for(this.comparisonEnabled&&u.push({seriesHover:[]}),this.chartType==="bar"&&this.options.series.bars.align!=="left"&&(this.options.series.bars.align==="center"?g=this.options.series.bars.barWidth/2:g=this.options.series.bars.barWidth),e=0;e<t.length;e++){s=t[e];let y;s.datasource.isAdditional?y=i.x2:y=i.x,y+=g,a=this.findHoverIndexFromData(y,s),s.data[a]&&s.data[a][0]&&(l=y-s.data[a][0],o=s.data[a][0],s.datasource.isAdditional?(!d||l>=0&&(l<d||d<0)||l<0&&l>d)&&(d=l,r=o):(!h||l>=0&&(l<h||h<0)||l<0&&l>h)&&(h=l,n=o),s.stack?this.tooltipIndividual||!this.tooltipCumulative?c=s.data[a][1]:(p+=s.data[a][1],c=p):c=s.data[a][1],(s.stack||s.curvedLines&&s.curvedLines.apply)&&(a=this.findHoverIndexFromDataPoints(y,s,a)),(!this.hideZeros||c)&&(f={value:c,hoverIndex:a,color:s.dataKey.color,label:s.dataKey.label,units:s.dataKey.units,decimals:s.dataKey.decimals,tooltipValueFormatFunction:s.dataKey.tooltipValueFormatFunction,time:o,distance:l,index:e},s.datasource.isAdditional?u[1].seriesHover.push(f):u[0].seriesHover.push(f)))}return u[1]&&u[1].seriesHover.length&&(u[1].time=r),u[0].time=n,u}findHoverIndexFromData(t,i){let e=0,s=i.data.length-1,a,l=null;for(;l===null;){if(e>s)return Math.max(s,0);if(a=Math.floor((e+s)/2),i.data[a][0]===t)return a;i.data[a][0]<t?e=a+1:s=a-1}}findHoverIndexFromDataPoints(t,i,e){let s=i.datapoints.pointsize,a=e*s,l=i.datapoints.points.length,h;for(h=a;h<l;h+=s)if(!i.lines.steps&&i.datapoints.points[a]!=null&&i.datapoints.points[h]==null||i.datapoints.points[h]>t)return Math.max(h-s,0)/s;return h/s-1}pieDataRendered(){for(let t=0;t<this.pieTargetData.length;t++){let i=this.pieTargetData[t]?this.pieTargetData[t]:0;this.pieRenderedData[t]=i,this.pieData[t].data[0]||(this.pieData[t].data[0]=[0,0]),this.pieData[t].data[0][1]=i}}nextPieDataAnimation(t){if(t){this.finishPieDataAnimation(),this.pieAnimationStartTime=this.pieAnimationLastTime=Date.now();for(let i=0;i<this.subscription.data.length;i++)this.pieTargetData[i]=this.subscription.data[i].data&&this.subscription.data[i].data[0]?this.subscription.data[i].data[0][1]:0}this.pieAnimationCaf&&(this.pieAnimationCaf(),this.pieAnimationCaf=null),this.pieAnimationCaf=this.ctx.$scope.raf.raf(this.onPieDataAnimation.bind(this))}onPieDataAnimation(){let t=Date.now(),i=t-this.pieAnimationLastTime,e=(t-this.pieAnimationStartTime)/this.pieDataAnimationDuration;if(e>=1)this.finishPieDataAnimation();else{if(i>=40){for(let s=0;s<this.pieTargetData.length;s++){let a=this.pieRenderedData[s],l=this.pieTargetData[s],h=a+(l-a)*e;this.pieData[s].data[0]||(this.pieData[s].data[0]=[0,0]),this.pieData[s].data[0][1]=h}this.plot.setData(this.pieData),this.plot.draw(),this.pieAnimationLastTime=t}this.nextPieDataAnimation(!1)}}finishPieDataAnimation(){this.pieDataRendered(),this.plot.setData(this.pieData),this.plot.draw()}onPieSliceClick(t,i){let e=this.ctx.actionsApi.getActionDescriptors("sliceClick");if(t&&e.length){t.stopPropagation();let s=i.series.datasource,a=s?s.entity?.id:null,l=s?s.entityName:null,h=s?s.entityLabel:null;this.ctx.actionsApi.handleWidgetAction(t,e[0],a,l,i,h)}}};export{z as a};
